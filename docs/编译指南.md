# SimpleTodo 编译指南

## 概述

SimpleTodo 使用 PowerShell 脚本进行自动化编译，支持 Debug/Release 两种配置，依赖 Visual Studio C++ 编译器和 Windows SDK。

## 环境要求

| 组件            | 最低版本  | 说明                   |
| ------------- | ----- | -------------------- |
| Windows SDK   | 10.0+ | 提供 rc.exe、mt.exe 等工具 |
| Visual Studio | 2015+ | 提供 cl.exe 编译器        |
| PowerShell    | 5.0+  | 运行编译脚本               |

## 快速开始

### 基本命令

```powershell
# 查看帮助（不编译）
.\scripts\build.ps1

# 编译 Release 版本
.\scripts\build.ps1 -Configuration Release

# 编译 Release 版本（静默模式，减少输出）
.\scripts\build.ps1 -Configuration Release -Quiet

# 重新编译 Debug 版本（Clean + Build）
.\scripts\build.ps1 -Configuration Debug -Rebuild
```

### 参数说明

| 参数               | 必填  | 说明                       |
| ---------------- | --- | ------------------------ |
| `-Configuration` | 是   | 编译配置：`Debug` 或 `Release` |
| `-Rebuild`       | 否   | 先清理输出目录再编译（保留 data 目录）   |
| `-Quiet`         | 否   | 静默模式，隐藏详细编译输出            |
| `-Help`          | 否   | 显示帮助信息                   |

### 输出产物

编译产物位于 `bin\x64\<Configuration>` 目录：

```
bin\x64\Release\
├── SimpleTodo.exe      # 主程序
├── SimpleTodo.res      # 资源文件
└── data/               # 数据目录（编译时保留）
```

## 编译脚本分析

### 架构设计

脚本分为以下模块：

```
build.ps1
├── 参数解析
├── 辅助函数
│   ├── Find-LatestWindowsSdkVersion  # 查找最新 SDK 版本
│   └── Find-MtExe                    # 查找 mt.exe
├── 环境配置
│   ├── 查找 Visual Studio (cl.exe)
│   ├── 查找 Windows SDK (rc.exe)
│   └── 查找 mt.exe (用于 manifest 嵌入)
├── 资源编译 (rc.exe)
├── 源文件编译 (cl.exe)
├── Manifest 嵌入 (mt.exe)
└── 完成提示
```

### 核心功能

#### 1. 工具链自动检测

脚本自动查找以下工具，无需手动配置路径：

| 工具     | 用途            | 查找方式        |
| ------ | ------------- | ----------- |
| cl.exe | C++ 编译器       | vswhere.exe |
| rc.exe | 资源编译器         | Windows SDK |
| mt.exe | Manifest 嵌入工具 | Windows SDK |

#### 2. SDK 版本管理

自动选择最新版本的 Windows SDK，避免版本冲突：

```powershell
# 查找策略：版本号降序排列，取第一个
$sdkVersions = Get-ChildItem $binPath | Where-Object { $_.Name -match "^10\.0\.\d+\.0$" } | Sort-Object Name -Descending
```

#### 3. 路径处理

使用相对路径，支持项目目录迁移：

```powershell
$scriptRoot = Split-Path -Parent (Split-Path -Parent $MyInvocation.MyCommand.Path)
$srcDir = Join-Path $scriptRoot "src"
```

#### 4. Manifest 嵌入

确保 Common Controls 6.0 正确加载：

```powershell
& $mtPath -manifest $manifestPath -outputresource:"$outputExe;#1"
```

### 编译器选项

| 选项       | Debug | Release | 说明   |
| -------- | ----- | ------- | ---- |
| /O2      | -     | ✅       | 优化级别 |
| /Od      | ✅     | -       | 禁用优化 |
| /Zi      | ✅     | -       | 调试信息 |
| /MTd     | ✅     | -       | 运行时库 |
| /MT      | -     | ✅       | 运行时库 |
| /D_DEBUG | ✅     | -       | 调试符号 |
| /DNDEBUG | -     | ✅       | 发布符号 |

## 常见问题

### Q: 编译失败，提示找不到 cl.exe

**解决**：确保已安装 Visual Studio C++ 构建工具。

### Q: 工具栏按钮不显示

**解决**：确保 manifest 已嵌入 exe。检查方式：

```powershell
# 用记事本打开 exe，搜索是否有以下内容：
# <assemblyIdentity name="Microsoft.Windows.Common-Controls" ... />
```

### Q: Release 版拷贝到其他机器无法运行

**可能原因**：

1. 缺少 Visual C++ 运行库
2. manifest 未正确嵌入
3. comctl32.dll 版本问题

**解决**：代码中已添加 `LoadLibrary(L"comctl32.dll")` 强制加载 DLL。

## 项目结构

```
simple-todo/
├── src/                    # 源代码
│   ├── SimpleTodo.cpp      # 入口文件
│   ├── MainFrm.cpp        # 主窗口
│   ├── SimpleTodo.rc       # 资源脚本
│   └── ...
├── third_party/            # 第三方依赖
│   └── WTL/               # Windows Template Library
├── bin/                    # 编译输出
│   └── x64/
│       ├── Debug/
│       └── Release/
├── scripts/
│   └── build.ps1          # 编译脚本
└── docs/                   # 文档
```

---

最后更新: 2026-02-04
